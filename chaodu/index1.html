<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è¶…åº¦åå°ç®¡ç†ç³»ç»Ÿ</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #fff8e7; }
  </style>
</head>
<body class="p-4">
<div class="container">
  <h2 class="text-center mb-4">ğŸª” è¶…åº¦åå°ç®¡ç†ç³»ç»Ÿ</h2>

  <div class="mb-3 d-flex flex-column align-items-center">
    <div class="d-inline-flex align-items-center gap-2" style="max-width: 600px;">
      <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢..." style="width: 300px;">
      <button onclick="searchPhone()" class="btn btn-primary">æŸ¥è¯¢</button>
      <button onclick="clearForm()" class="btn btn-success">æ–°å¢</button>
    </div>
    <div id="searchResults" class="mt-3"></div> <!-- âœ… æ–°å¢é€™è¡Œï¼ -->
    <div class="text-end mt-2" style="width: 100%;">
      ç®¡ç†å‘˜ï¼š<span id="whoLogin" class="fw-bold text-primary"></span>
      <button onclick="logout()" class="btn btn-sm btn-outline-secondary ms-2">ç™»å‡º</button>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-3">
      <label>é˜³ä¸ŠæŠ¥æ©äººï¼š</label>
      <input id="mainName" class="form-control">
    </div>
    <div class="col-md-3">
      <label>æ‰‹æœºå·</label>
      <input id="phoneNumber" class="form-control">
    </div>
    <div class="col-md-6">
      <label>é˜³ä¸Šåœ°å€ï¼š</label>
      <input id="address" class="form-control">
    </div>
  </div>

  <div class="row g-3 mt-3">
    <div class="col-md-3">
      <label>æ³•ä¼šç±»åˆ«</label>
      <select id="festival" class="form-select">
        <option value="">è¯·é€‰æ‹©</option>
        <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
        <option value="ä¸­å…ƒèŠ‚">ä¸­å…ƒèŠ‚</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
    </div>
    <div class="col-md-3">
      <label>éšå–œä¾›å…»é‡‘é¢</label>
      <input id="donation" type="number" min="0" class="form-control" oninput="calculateTotal()">
    </div>
    <div class="col-md-3">
      <label>æ”¶æ®ç¼–å·</label>
      <input id="receiptNumber" class="form-control">
    </div>
    <div class="col-md-3">
      <label>æ”¶æ¬¾æ—¥æœŸ</label>
      <input id="receiptDate" type="date" class="form-control">
    </div>
  </div>

  <div class="row mt-3">
    <div class="col-md-12 d-flex justify-content-end gap-2">
      <button id="btnSubmit" class="btn btn-success">æäº¤ä¿å­˜</button>
      <button id="btnUpdate" class="btn btn-primary">æ›´æ–°ä¿å­˜</button>
      <button id="btnDelete" class="btn btn-danger">åˆ é™¤</button>
      <button onclick="printEntry()" class="btn btn-secondary">æ‰“å°</button>
      <button onclick="openReceiptPrint()">ğŸ–¨ï¸ æ‰“å°å°ç¥¨</button>
    </div>
  </div>

  <hr>
  <div id="totalAmountDisplay" class="text-end mt-3 fw-bold fs-5"></div>
  <div id="groupsContainer">
    <div id="group-ancestor"></div>
    <div id="group-baby"></div>
    <div id="group-enemy"></div>
    <div id="group-past"></div>
    <div id="group-ground"></div>
  </div>
</div>
<script src="script/submit.js"></script>
<script src="script/update.js"></script>
<script src="script/delete.js"></script>
<script src="script/print.js"></script>
<script>
function searchPhone() {
  const keyword = document.getElementById("searchInput").value.trim();
  if (!keyword) return;

  fetch(`https://form.gealarm2012.workers.dev/admin-chaodu?search=${encodeURIComponent(keyword)}`)
    .then(res => res.json())
    .then(results => {
      const container = document.getElementById("searchResults");
      container.innerHTML = "";
      if (results.length === 1) {
        clearForm();
        setTimeout(() => loadEntry(results[0]), 50);
      } else if (results.length > 1) {
        const select = document.createElement("select");
        select.className = "form-select mt-2";
        select.onchange = e => {
          const selected = results.find(r => r[2] === e.target.value);
          if (selected) {
            clearForm();
            setTimeout(() => loadEntry(selected), 50);
          }
        };
        select.innerHTML = '<option value="">é€‰æ‹©æŸ¥è¯¢ç»“æœ</option>' +
          results.map(r => `<option value="${r[2]}">${r[1]} - ${r[2]}</option>`).join("");
        container.appendChild(select);
      } else {
        container.textContent = "æœªæ‰¾åˆ°ç›¸å…³è®°å½•";
      }
    })
    .catch(err => {
      alert("æŸ¥è¯¢å¤±è´¥");
      console.error(err);
    });
}
</script>
<script>
const fieldsMap = {
  "group-ancestor": [
    { key: "ancestorName", label: "ç¥–å…ˆ / äº¡çµ å§“å", row: 0, col: 3 },
    { key: "placeType", label: "ç‰Œä½ç±»åˆ«", row: 0, col: 3 },
    { key: "location", label: "å®‰å¥‰åœ°ç‚¹", row: 0, col: 6 },
    { key: "token", label: "è¶…åº¦ä»¤ç‰Œ", type: "number", row: 1, col: 3 },
    { key: "boat", label: "æ³•èˆ¹é…å¥— 30", type: "number", row: 1, col: 3 },
    { key: "lotus", label: "è²èŠ±", type: "number", row: 1, col: 3 },
    { key: "paper3", label: "çº¸é‡‘3", type: "number", row: 1, col: 3 },
    { key: "paper6", label: "çº¸é‡‘6", type: "number", row: 2, col: 3 },
    { key: "paper27", label: "çº¸é‡‘27", type: "number", row: 2, col: 3 },
    { key: "extra", label: "é…å¥—ä»¤ç‰Œå¤‡æ³¨", row: 2, col: 3 }
  ],
  "group-baby": [
    { key: "yang", label: "é˜³ä¸Š", row: 0, col: 3 },
    { key: "location", label: "ä¹‹æ°´å­çµã€è²ä½:", row: 0, col: 3 },
    { key: "token", label: "è¶…åº¦ä»¤ç‰Œ", type: "number", row: 0, col: 3 },
    { key: "boat", label: "æ³•èˆ¹é…å¥— 30", type: "number", row: 0, col: 3 },
    { key: "lotus", label: "è²èŠ±", type: "number", row: 1, col: 3 },
    { key: "paper3", label: "çº¸é‡‘3", type: "number", row: 1, col: 3 },
    { key: "paper6", label: "çº¸é‡‘6", type: "number", row: 1, col: 3 },
    { key: "paper27", label: "çº¸é‡‘27", type: "number", row: 1, col: 3 },
    { key: "extra", label: "é…å¥—ä»¤ç‰Œå¤‡æ³¨", row: 2, col: 3 }
  ],
  "group-enemy": [
    { key: "yang", label: "é˜³ä¸Š", row: 0, col: 3 },
    { key: "location", label: "ç¼ èº«çµ/å†¤äº²å€ºä¸»ã€ç‰Œä½ï¼š", row: 0, col: 3 },
    { key: "token", label: "è¶…åº¦ä»¤ç‰Œ", type: "number", row: 0, col: 3 },
    { key: "boat", label: "æ³•èˆ¹é…å¥— 30", type: "number", row: 0, col: 3 },
    { key: "lotus", label: "è²èŠ±", type: "number", row: 1, col: 3 },
    { key: "paper3", label: "çº¸é‡‘3", type: "number", row: 1, col: 3 },
    { key: "paper6", label: "çº¸é‡‘6", type: "number", row: 1, col: 3 },
    { key: "paper27", label: "çº¸é‡‘27", type: "number", row: 1, col: 3 },
    { key: "extra", label: "é…å¥—ä»¤ç‰Œå¤‡æ³¨", row: 2, col: 3 }
  ],
  "group-past": [
    { key: "yang", label: "é˜³ä¸Š", row: 0, col: 3 },
    { key: "token", label: "è¶…åº¦ä»¤ç‰Œ", type: "number", row: 0, col: 3 },
    { key: "boat", label: "æ³•èˆ¹é…å¥— 30", type: "number", row: 0, col: 3 },
    { key: "lotus", label: "è²èŠ±", type: "number", row: 0, col: 3 },
    { key: "paper3", label: "çº¸é‡‘3", type: "number", row: 1, col: 3 },
    { key: "paper6", label: "çº¸é‡‘6", type: "number", row: 1, col: 3 },
    { key: "paper27", label: "çº¸é‡‘27", type: "number", row: 1, col: 3 },
    { key: "extra", label: "é…å¥—ä»¤ç‰Œå¤‡æ³¨", row: 1, col: 3 }
  ],
  "group-ground": [
    { key: "location", label: "åœ°å€", row: 0, col: 9 },
    { key: "token", label: "è¶…åº¦ä»¤ç‰Œ", type: "number", row: 0, col: 3 },
    { key: "boat", label: "æ³•èˆ¹é…å¥— 30", type: "number", row: 1, col: 3 },
    { key: "lotus", label: "è²èŠ±", type: "number", row: 1, col: 3 },
    { key: "paper3", label: "çº¸é‡‘3", type: "number", row: 1, col: 3 },
    { key: "paper6", label: "çº¸é‡‘6", type: "number", row: 1, col: 3 },
    { key: "paper27", label: "çº¸é‡‘27", type: "number", row: 2, col: 3 },
    { key: "extra", label: "é…å¥—ä»¤ç‰Œå¤‡æ³¨", row: 2, col: 3 }
  ]
};
</script>
<script>
function createFieldsBlock(fields, index = 0, title = '') {
  const card = document.createElement("div");
  card.className = "card p-3 mb-3 position-relative";

  const heading = document.createElement("h6");
  heading.className = "fw-semibold mb-2";
  heading.textContent = `${title ? title + ' ' : ''}ç¬¬ ${index + 1} ä½`;
  card.appendChild(heading);

  const close = document.createElement("div");
  close.style = "position:absolute;top:5px;right:10px;cursor:pointer;";
  close.innerText = "âŒ";
  close.onclick = () => {
    card.remove();
    calculateTotal();
  };
  card.appendChild(close);

  const rows = [document.createElement("div"), document.createElement("div"), document.createElement("div")];
  rows.forEach((row, idx) => row.className = idx === 0 ? "row g-2" : "row g-2 mt-2");

  fields.forEach(field => {
    const col = document.createElement("div");
    col.className = `col-md-${field.col || 3}`;
    let innerHTML = "";

    const labelStyle = "font-size: 0.85rem; font-weight: 500;";

    if (field.key === 'placeType') {
      innerHTML = `<label style="${labelStyle}">${field.label}</label>
        <select class="form-select" data-key="${field.key}" onchange="calculateTotal()">
          <option value="">è¯·é€‰æ‹©</option>
          <option value="åœ°è—æ®¿ç‰Œä½">åœ°è—æ®¿ç‰Œä½</option>
          <option value="çµéª¨æ®¿ç¦ä½">çµéª¨æ®¿ç¦ä½</option>
          <option value="å¢“å›­">å¢“å›­</option>
          <option value="ç‰Œä½">ç‰Œä½</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>`;
    } else {
      innerHTML = `<label style="${labelStyle}">${field.label}</label>
        <input class="form-control" data-key="${field.key}" type="${field.type || 'text'}" oninput="calculateTotal()">`;
    }

    col.innerHTML = innerHTML;
    rows[field.row || 0].appendChild(col);
  });

  rows.forEach(row => card.appendChild(row));
  return card;
}

function calculateTotal() {
  const priceMap = { token: 5, boat: 30, lotus: 6, paper3: 3, paper6: 6, paper27: 27 };
  const nameMap = { token: 'è¶…åº¦ä»¤ç‰Œ', boat: 'æ³•èˆ¹é…å¥—', lotus: 'è²èŠ±', paper3: 'çº¸é‡‘3', paper6: 'çº¸é‡‘6', paper27: 'çº¸é‡‘27' };
  const countMap = { token: 0, boat: 0, lotus: 0, paper3: 0, paper6: 0, paper27: 0 };
  let total = 0;

  document.querySelectorAll("input[data-key], select[data-key]").forEach(el => {
    const key = el.dataset.key;
    const value = parseFloat(el.value || 0);
    if (priceMap[key]) {
      countMap[key] += value;
      total += value * priceMap[key];
    }
  });

  const donation = parseFloat(document.getElementById("donation")?.value || 0);
total += donation;

const detailLines = Object.entries(countMap).map(([key, count]) => {
  const subtotal = count * priceMap[key];
  return `
    <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 0.85rem; margin-bottom: 2px; line-height: 1.3;">
      <div style="min-width: 100px; text-align: left;">${nameMap[key]}</div>
      
      <div style="display: flex; align-items: center; justify-content: center; gap: 4px; min-width: 120px;">
        <div style="width: 40px; text-align: right;">${count}</div>
        <div style="width: 10px; text-align: center;">Ã—</div>
        <div style="width: 50px; text-align: left;">${priceMap[key]}</div>
      </div>

      <div style="display: flex; align-items: center; justify-content: flex-end; gap: 2px; min-width: 100px;">
        <span>RM</span>
        <span style="min-width: 60px; text-align: right; font-variant-numeric: tabular-nums;">${subtotal.toFixed(2)}</span>
      </div>
    </div>`;
});

// ğŸ‘‰ æ’å…¥éšå–œä¾›å…»
detailLines.push(`
  <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 0.9rem; margin-top: 8px; font-weight: bold; line-height: 1.3;">
    <div style="min-width: 100px; text-align: left;">éšå–œä¾›å…»</div>
    <div style="min-width: 120px; text-align: center;"></div>
    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 2px; min-width: 100px;">
      <span>RM</span>
      <span style="min-width: 60px; text-align: right; font-variant-numeric: tabular-nums;">${donation.toFixed(2)}</span>
    </div>
  </div>
`);

// ğŸ‘‰ æ’å…¥æ€»é‡‘é¢
detailLines.push(`
  <div style="display: flex; justify-content: flex-end; align-items: center; gap: 8px; font-size: 1rem; margin-top: 6px; font-weight: bold; line-height: 1.3;">
    <div style="min-width: 100px; text-align: left;">æ€»é‡‘é¢</div>
    <div style="min-width: 120px; text-align: center;"></div>
    <div style="display: flex; align-items: center; justify-content: flex-end; gap: 2px; min-width: 100px;">
      <span>RM</span>
      <span style="min-width: 60px; text-align: right; font-variant-numeric: tabular-nums;">${total.toFixed(2)}</span>
    </div>
  </div>
`);

const display = document.getElementById("totalAmountDisplay");
if (display) {
  display.innerHTML = `<div style="text-align: right;">${detailLines.join("")}</div>`;
}
}

const groupTitleMap = {
  'group-ancestor': 'ç¥–å…ˆ / äº¡çµ',
  'group-baby': 'æ°´å­çµ',
  'group-enemy': 'ç¼ èº«çµ / å†¤äº²å€ºä¸»',
  'group-past': 'å‰ä¸–ä»Šç”Ÿæœ‰æ„æ— æ„æ‰€æ€ç”Ÿçµ',
  'group-ground': 'åœ°åŸºä¸» / åœŸåœ°å…¬'
};

const groupLimitMap = {
  'group-ancestor': 8,
  'group-baby': 5,
  'group-enemy': 5,
  'group-past': 4,
  'group-ground': 3
};


function loadEntry(row) {
  const get = id => document.getElementById(id);

  // ç›´æ¥èµ‹å€¼åŸºç¡€ä¿¡æ¯
  get("mainName").value = row[1] || "";
  get("phoneNumber").value = row[2] || "";
  get("address").value = row[3] || "";
  get("festival").value = row[231] || "";
  get("donation").value = row[230] || 0;
  get("receiptNumber").value = row[232] || "";
  get("receiptDate").value = formatDate(row[233]) || ""; // âœ… æ ¼å¼åŒ–æ”¶æ¬¾æ—¥æœŸ

  // æ¸…ç©ºç°æœ‰åˆ†ç»„è¡¨å•
  document.getElementById("groupsContainer").innerHTML = "";
  initGroups();

  // åˆ†ç»„å­—æ®µé…ç½®
  const groupConfigs = {
    "group-ancestor": { start: 4, count: 8 },
    "group-baby": { start: 84, count: 5 },
    "group-enemy": { start: 129, count: 5 },
    "group-past": { start: 174, count: 4 },
    "group-ground": { start: 206, count: 3 },
  };

  Object.entries(groupConfigs).forEach(([groupId, cfg]) => {
    const container = document.getElementById(groupId);
    const fields = fieldsMap[groupId];
    const keys = fields.map(f => f.key);
    const len = keys.length;

    for (let i = 0; i < cfg.count; i++) {
      const offset = cfg.start + i * len;
      const obj = {};
      let hasValue = false;

      for (let k = 0; k < len; k++) {
        const val = row[offset + k];
        obj[keys[k]] = val;
        if (val) hasValue = true;
      }

      if (hasValue) {
        const card = createFieldsBlock(fields, i, groupTitleMap[groupId]);
        const inputs = card.querySelectorAll("[data-key]");
        inputs.forEach(input => {
          const key = input.dataset.key;
          if (key in obj) input.value = obj[key];
        });
        container.appendChild(card);
      }
    }
  });

  calculateTotal();
}

// ğŸ› ï¸ æ—¥æœŸæ ¼å¼åŒ–å·¥å…·å‡½æ•°
function formatDate(isoString) {
  if (!isoString) return "";
  const date = new Date(isoString);
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  return `${year}-${month}-${day}`;
}

  </script>
 <script>
function openReceiptPrint() {
    const payload = buildPayload(); // è·å–å½“å‰è¡¨å•æ•°æ®
    const printWindow = window.open("receipt.html", "_blank");

    // âœ… å°è¯•è½®è¯¢ç›´åˆ°æ‰“å°çª—å£å‡†å¤‡å¥½
    const interval = setInterval(() => {
        if (printWindow && printWindow.document.readyState === "complete") {
            printWindow.postMessage(JSON.stringify(payload), "*");
            clearInterval(interval);
        }
    }, 100);
}

  </script>
   <script>
  function clearForm() {
  // âœ… 1. æ¸…é™¤åŸºç¡€ä¿¡æ¯
  const ids = ["mainName", "phoneNumber", "address", "festival", "donation", "receiptNumber", "receiptDate"];
  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // âœ… 2. æ¸…é™¤æœç´¢æ¡†
  const searchInput = document.getElementById("searchInput");
  if (searchInput) searchInput.value = "";

  // âœ… 3. æ¸…é™¤æœç´¢ç»“æœ
  const searchResults = document.getElementById("searchResults");
  if (searchResults) searchResults.innerHTML = "";

  // âœ… 4. æ¸…é™¤å°è®¡æ€»è®¡
  const totalAmountDisplay = document.getElementById("totalAmountDisplay");
  if (totalAmountDisplay) totalAmountDisplay.innerHTML = "";

  // âœ… 5. é‡ç½® groupsContainer
  const container = document.getElementById("groupsContainer");
  if (container) {
    container.innerHTML = "";
    initGroups();
  }

  // âœ… 6. é‡æ–°è®¡ç®—æ€»è®¡ï¼ˆé¿å…æ•°æ®æ®‹ç•™ï¼‰
  calculateTotal();
}

   // âœ… å…¨å±€ç¼–å·ç”Ÿæˆå‡½æ•°
   window.generateReceiptNumber = function () {
            const currentYear = new Date().getFullYear();
            const storedYear = localStorage.getItem("receiptYear");
            
            // âœ… å¦‚æœå¹´ä»½å˜äº†ï¼Œé‡ç½®è®¡æ•°å™¨
            if (storedYear !== String(currentYear)) {
                localStorage.setItem("receiptCounter", 1);
                localStorage.setItem("receiptYear", currentYear);
            }

            // âœ… è¯»å–å½“å‰è®¡æ•°å™¨
            let counter = parseInt(localStorage.getItem("receiptCounter")) || 1;

            // âœ… ç”Ÿæˆç¼–å·ï¼Œä¾‹å¦‚ MLTS-2025-0001
            const receiptNumber = `LCDR-${currentYear}-${String(counter).padStart(4, '0')}`;

            // âœ… å¢åŠ è®¡æ•°å™¨å¹¶ä¿å­˜åˆ° localStorage
            localStorage.setItem("receiptCounter", counter + 1);

            return receiptNumber;
        };

        function resetReceiptCounter() {
            localStorage.removeItem("receiptCounter");
            localStorage.removeItem("receiptYear");
            localStorage.removeItem("lastPrintedReceiptNumber");
            console.log("âœ… ç¼–å·è®¡æ•°å™¨å·²é‡ç½®");
            alert("âœ… ç¼–å·è®¡æ•°å™¨å·²é‡ç½®");
        }


  
function initGroups() {
  Object.entries(groupTitleMap).forEach(([groupId, title]) => {
    const groupDiv = document.createElement("div");
    groupDiv.className = "mb-4";
    groupDiv.innerHTML = `<h5 class='mb-3'>${title}ï¼ˆæœ€å¤š ${groupLimitMap[groupId]} ä½ï¼‰</h5>`;

    const container = document.createElement("div");
    container.id = groupId;
    groupDiv.appendChild(container);

    const addBtn = document.createElement("button");
    addBtn.className = "btn btn-outline-primary mb-2";
    addBtn.textContent = `â• æ–°å¢${title}å¯¹è±¡`;
    addBtn.onclick = () => {
      const fields = fieldsMap[groupId];
      if (container.children.length >= groupLimitMap[groupId]) return alert(`æœ€å¤šåªèƒ½å¡«å†™ ${groupLimitMap[groupId]} ä½`);
      container.appendChild(createFieldsBlock(fields, container.children.length, title));
      calculateTotal();
    };

    groupDiv.appendChild(addBtn);
    document.getElementById("groupsContainer").appendChild(groupDiv);
  });
}
  </script>
  <script>
    function printEntry() {
      const get = id => document.getElementById(id)?.value || "";
      const groups = ["group-ancestor", "group-baby", "group-enemy", "group-past", "group-ground"];
    
      const data = {
        mainName: get("mainName"),
        phoneNumber: get("phoneNumber"),
        address: get("address"),
        festival: get("festival"),
        donation: get("donation")
      };
    
      groups.forEach(groupId => {
        const groupList = [];
        const cards = document.querySelectorAll(`#${groupId} .card`);
        cards.forEach(card => {
          const obj = {};
          card.querySelectorAll("[data-key]").forEach(input => {
            const key = input.dataset.key;
            obj[key] = input.value;
          });
          groupList.push(obj);
        });
        data[groupId] = groupList;
      });
    
      localStorage.setItem("printData", JSON.stringify(data));
      window.open("print.html", "_blank");
    }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        document.getElementById("btnSubmit")?.addEventListener("click", submitData);
        document.getElementById("btnUpdate")?.addEventListener("click", updateData);
        document.getElementById("btnDelete")?.addEventListener("click", deleteEntry);
      });
      </script>
        <script>
          const admin = localStorage.getItem("admin");
          if (!admin) {
            alert("è¯·å…ˆç™»å½•ï¼");
            location.href = "https://leizs2025.github.io/houtai/login.html";
          } else {
            document.getElementById("whoLogin").textContent = admin;
          }
      
          function logout() {
            localStorage.removeItem("admin");
            location.href = "https://leizs2025.github.io/houtai/login.html";
          }
        </script>
    
</body>
</html>
