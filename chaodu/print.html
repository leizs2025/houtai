<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>è¶…åº¦æ‰“å°è¡¨æ ¼</title>
  <style>
    @page { size: A4; margin: 8mm; }
    body {
      font-family: "Segoe UI", sans-serif;
      font-size: 8px;
      max-width: 700px;
      margin: auto;
      color: #000;
    }
    .logo { height: 80px; width : auto; object-fit: contain; }
    .logo-right { margin-top: 6px; /* ğŸ‘ˆ æ§åˆ¶å³è¾¹Logoå¾€ä¸‹4px */}
    .header-block { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; }
    .header-center { flex: none; text-align: center; width: 100%; /* ğŸ‘ˆ è®©ä¸­é—´å±…ä¸­ï¼Œå æ»¡ */ max-width: 500px; /* ğŸ‘ˆ æ§åˆ¶æœ€å¤§å®½åº¦ */}
    .temple-name { font-size: 26px; font-weight: bold; margin: 0; line-height: 1.3;}
    .sub-title { font-size: 20px; /* æ¯”åº™åå°ä¸€ç‚¹ */ font-weight: bold; margin-top: 4px; line-height: 1.2;}
    .header-line { font-size: 10px; font-weight: bold; }
    .main-table th, .main-table td {height: 22px;}
    .main-title { text-align: center; font-size: 18px; font-weight: bold; margin: 8px 0 10px; letter-spacing: 0.5px; line-height: 1.3;}
    .info-line { font-size: 8px; margin: 0 0 2px 6px; text-align: left; }
    .group-title { font-weight: bold; font-size: 9px; margin: 6px 0 2px; }
    table { width: 100%; border-collapse: collapse; font-size: 9px; margin: 2px 0; }
    th, td {border: 1px solid #000; padding: 1px 2px; text-align: center; vertical-align: middle; line-height: 1.1; word-break: break-word; white-space: normal; }
    .engraving { font-size: 8px; text-align: center; font-style: italic; margin-top: 4px; }
    .summary-wrapper { margin-top: 6px; page-break-inside: avoid; break-inside: avoid; }
    .summary-table { margin-top: 6px;  width: 100%;  border: none;  font-size: 8px;  table-layout: fixed; /* è¡¨æ ¼å®šå®½ï¼Œä¿è¯å¯ä»¥æ§åˆ¶ä¹å®«æ ¼å®½åº¦ */}
    .summary-table td { padding: 1px 2px;  vertical-align: middle;  text-align: left;  border: none;  white-space: nowrap;  overflow: hidden;  text-overflow: ellipsis;  line-height: 1.2;}
    td.col-9 { width:80%; /* ä¹å®«æ ¼å 85% */}
    td.col-2 { width:20%; /* å³è¾¹å 15% */ text-align: right;  font-weight: bold;  font-size: 9px;  padding-left: 10px;}
    .summary-footer-donation { text-align: right; font-weight: normal; font-size: 9px; padding-right: 4px; }
    .summary-footer-total { text-align: right; font-weight: bold; font-size: 9px; padding-right: 4px; }
    @media print { 
      body { transform: scale(1.0); transform-origin: top center; }
      .no-print { display: none !important; }
    }
  </style>
</head>
<body>

<div class="header-block">
  <img src="left-logo.jpg" class="logo" alt="å·¦ Logo">
  <div class="header-center">
    <div class="temple-name">çœŸä½›å®—è¯—å·«å¦™ç†é›·è—å¯º</div> <!-- ç¬¬ä¸€è¡Œåº™å -->
    <div class="sub-title">è¯šç¥ˆæ ¹æœ¬ä¼ æ‰¿ä¸Šå¸ˆè²ç”Ÿæ´»ä½›åŠæ³•ä¼šå…‰æ˜è¯¸å°Šæ”¾å…‰åŠ æŒ</div> <!-- ğŸ‘ˆ æ–°å¢çš„å°æ ‡é¢˜ï¼Œåº™åä¸‹é¢ -->
    <div class="main-title" id="mainTitle"></div>
    </div>
  <img src="right-logo.jpg" class="logo" alt="å³ Logo">
</div>


<div class="info-line">é˜³ä¸ŠæŠ¥æ©äººï¼š<span id="mainName"></span>ã€€æ‰‹æœºå·ï¼š<span id="phoneNumber"></span></div>
<div class="info-line">é˜³ä¸Šåœ°å€ï¼š<span id="address"></span></div>

<div style="text-align: right; margin-bottom: 10px;">
  <button onclick="window.print()" class="no-print" 
    style="padding: 6px 16px; font-size: 12px; background: #4caf50; color: white; border: none; border-radius: 4px; cursor: pointer;">
    ğŸ–¨ï¸ æ‰“å°è¡¨æ ¼
  </button>
</div>

<div id="tableContainer"></div>

<div class="summary-wrapper">
  <table class="summary-table">
    <tbody id="summaryTable"></tbody>
  </table>
</div>



<script>
window.onload = function () {
  const data = JSON.parse(localStorage.getItem("printData") || '{}');

  document.getElementById("phoneNumber").textContent = data.phoneNumber || "";
  document.getElementById("mainName").textContent = data.mainName || "";
  document.getElementById("address").textContent = data.address || "";

  const titleMap = {
    "æ¸…æ˜èŠ‚": "æ¸…æ˜èŠ‚è¶…åº¦åŠŸå¾·å›å‘è¡¨",
    "ä¸­å…ƒèŠ‚": "ä¸­å…ƒèŠ‚ç™½è²èŠ±ç‹è—å¯†å¼æŠ¤æ‘© æ³•ä¼šã€ è¶…åº¦ ã€‘æŠ¥åè¡¨æ ¼ 																",
    "å…¶ä»–": "è¶…åº¦ç¥ˆç¦åŠŸå¾·å›å‘è¡¨"
  };
  const title = document.getElementById("mainTitle");
  if (data.festival && titleMap[data.festival]) {
    title.textContent = titleMap[data.festival];
  } else {
    title.style.display = "none";
  }

  const container = document.getElementById("tableContainer");
  const groupTitles = {
    "group-ancestor": "ç¥–å…ˆ / äº¡çµ",
    "group-baby": "æ°´å­çµ",
    "group-enemy": "ç¼ èº«çµ / å†¤äº²å€ºä¸»",
    "group-past": "å‰ä¸–ä»Šç”Ÿæ‰€æ€ç”Ÿçµ",
    "group-ground": "åœ°åŸºä¸» / åœŸåœ°å…¬"
  };
  const groupLimits = {
    "group-ancestor": 8,
    "group-baby": 5,
    "group-enemy": 5,
    "group-past": 4,
    "group-ground": 3
  };
  const allTotals = { token: 0, boat: 0, lotus: 0, paper3: 0, paper6: 0, paper27: 0 };
  const priceFields = ["token", "boat", "lotus", "paper3", "paper6", "paper27", "extra"];
  const displayMap = {
    token: "è¶…åº¦ä»¤ç‰Œ", boat: "æ³•èˆ¹é…å¥—30", lotus: "è²èŠ±",
    paper3: "çº¸é‡‘3", paper6: "çº¸é‡‘6", paper27: "çº¸é‡‘27", extra: "ä»¤ç‰Œé…å¥—"
  };
  const secondColumnTitles = {
    'group-ancestor': 'å¦™ç†é›·è—å¯º åœ°è—/ çµéª¨æ®¿ /å¢“å›­ / å…¶ä»– ',
    'group-baby': 'å¦™ç†é›·è—æ®¿ æ°´å­çµè²ä½',
    'group-enemy': 'å¦™ç†é›·è—æ®¿ å†¤äº²å€ºä¸»ç‰Œä½',
    'group-past': 'å‰ä¸–ä»Šç”Ÿæ‰€æ€ç”Ÿçµ',
    'group-ground': 'åœ°å€'
  };

  Object.keys(groupTitles).forEach(groupKey => {
    const list = data[groupKey] || [];
    const limit = groupLimits[groupKey];
    let html = `<div class='group-title'>${groupTitles[groupKey]}</div>`;
    html += `<table class='main-table'><colgroup><col style='width:110px;'><col style='width:240px;'><col style='width:32px;'><col style='width:32px;'><col style='width:32px;'><col style='width:32px;'><col style='width:32px;'><col style='width:32px;'><col style='width:32px;'></colgroup><thead><tr>`;
    if (groupKey === 'group-ancestor') {
      html += `<th>ç¥–å…ˆ / äº¡çµ å§“å</th><th>${secondColumnTitles[groupKey]}</th>`;
    } else if (groupKey === 'group-ground') {
      html += `<th colspan='2'>${secondColumnTitles[groupKey]}</th>`;
    } else {
      html += `<th>é˜³ä¸Š</th><th>${secondColumnTitles[groupKey]}</th>`;
    }
    priceFields.forEach(f => html += `<th>${displayMap[f]}</th>`);
    html += `</tr></thead><tbody>`;
    for (let i = 0; i < limit; i++) {
      const row = list[i] || {};
      html += `<tr>`;
      if (groupKey === 'group-ancestor') {
        const content = (row.placeType || '') + (row.location ? 'ï¼š' + row.location : '');
        html += `<td>${row.ancestorName || ''}</td><td style='text-align:left;padding-left:6px;'>${content || ''}</td>`;
      } else if (groupKey === 'group-ground') {
        html += `<td colspan='2' style='text-align:left;padding-left:6px;'>${row.location || ''}</td>`;
      } else {
        if (groupKey === 'group-past') {
          html += `<td>${row.yang || ''}</td><td style='text-align:left;padding-left:6px;color:#666;'>å‰ä¸–ä»Šç”Ÿæ‰€æ€ç”Ÿçµ</td>`;
        } else {
          html += `<td>${row.yang || ''}</td><td style='text-align:left;padding-left:6px;'>${row.location || ''}</td>`;
        }
      }
      priceFields.forEach(f => {
        html += `<td>${row[f] || ''}</td>`;
        if (!isNaN(parseInt(row[f])) && f !== 'extra') allTotals[f] += parseInt(row[f]);
      });
      html += `</tr>`;
    }
    html += `</tbody></table>`;
    if (groupKey === 'group-ground') {
      html += `<div class='engraving'>ä¸Šåˆ—è«¸éˆæ€ç”Ÿå‰ä¹‹ç½ªå’ï¼Œææ®å¾Œæ–¼æ²‰æ·ªï¼Œæ¬²æ±‚å‡ºè‹¦è¶…ç”Ÿï¼Œé¡»ä»—ä½›å…‰æ¥å¼•ï¼Œæ¶“ä»Šå‰æ—¦ï¼Œå»¶ä»—çœŸä½›å¯†æ³•ï¼Œå¾€ç”Ÿæ–¼è¥¿æ–¹æ¥µæ¨‚ä¸–ç•Œæ‘©è¨¶é›™è“®æ± ã€‚ã€‚</div>`;
    }
    container.innerHTML += html;
  });

  const summary = document.getElementById("summaryTable");

const priceMap = { token:5, boat:30, lotus:6, paper3:3, paper6:6, paper27:27 };
const nameMap = {
  token: "è¶…åº¦ä»¤ç‰Œ",
  boat: "æ³•èˆ¹é…å¥—30",
  lotus: "è²èŠ±",
  paper3: "çº¸é‡‘3",
  paper6: "çº¸é‡‘6",
  paper27: "çº¸é‡‘27"
};

let totalAmount = 0;
const keys = Object.keys(priceMap).filter(k => allTotals[k] > 0);

const donation = parseFloat(data.donation || 0);

// æ¯è¡Œä¹å®«æ ¼ï¼‹å³ä¾§ä¸€æ ¼
for (let i = 0; i < keys.length; i += 3) {
  const tr = document.createElement("tr");
  for (let j = 0; j < 3; j++) {
    const key = keys[i + j];
    if (key) {
      const qty = allTotals[key];
      const unit = priceMap[key];
      const subtotal = qty * unit;
      totalAmount += subtotal;
      tr.innerHTML += `<td>${nameMap[key]}</td><td>${qty} Ã— RM${unit.toFixed(2)}</td><td>= RM${subtotal.toFixed(2)}</td>`;
    } else {
      tr.innerHTML += `<td></td><td></td><td></td>`;
    }
  }


// å¦‚æœæ˜¯ç¬¬ä¸€è¡Œï¼ŒåŠ éšå–œä¾›å…»
if (i === 0 && donation > 0) {
  tr.innerHTML += `<td class="col-2" style="text-align:right;">
    <span style="margin-right:4px;">RM</span>
    <span style="min-width:60px; display:inline-block; text-align:right;">
      ${donation.toFixed(2)}
    </span>
  </td>`;
}
// å¦‚æœæ˜¯ç¬¬ä¸‰è¡Œï¼ŒåŠ æ€»é‡‘é¢
else if (i === 3) {
  tr.innerHTML += `<td class="col-2" style="text-align:right; font-weight:bold;">
    <span style="margin-right:4px;">RM</span>
    <span style="min-width:60px; display:inline-block; text-align:right;">
      ${(totalAmount + donation).toFixed(2)}
    </span>
  </td>`;
}
// å…¶ä»–è¡Œ
else {
  tr.innerHTML += `<td></td>`;
}



  summary.appendChild(tr);
}
autoResizeText("#summaryTable td:nth-child(1)");
autoResizeText("#summaryTable td:nth-child(2)");

};

function autoResizeText(selector) {
  const cells = document.querySelectorAll(selector);
  cells.forEach(cell => {
    let fontSize = 12; // ä»12pxå¼€å§‹
    cell.style.fontSize = fontSize + "px";
    while (cell.scrollHeight > cell.offsetHeight && fontSize > 7) {
      fontSize -= 0.5;
      cell.style.fontSize = fontSize + "px";
    }
  });
}

</script>

</body>
</html>
