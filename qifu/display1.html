<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®æ—¶æŠ¥åå±•ç¤º</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      background-color: #fff8e7;
    }
    .paid { color: green; font-weight: bold; }
    .unpaid { color: red; }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="container-fluid" style="max-width: 1400px;">
    <h3 class="mb-4 text-center">ğŸ“‹ è¶…åº¦ / ç¥ˆç¦ å®æ—¶æŠ¥ååˆ—è¡¨</h3>

    <!-- æ ‡ç­¾å¯¼èˆª -->
    <ul class="nav nav-tabs" id="formTabs" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="chaodu-tab" data-bs-toggle="tab" data-bs-target="#chaodu-pane" type="button" role="tab">ğŸª” è¶…åº¦æŠ¥å</button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="qifu-tab" data-bs-toggle="tab" data-bs-target="#qifu-pane" type="button" role="tab">ğŸ™ ç¥ˆç¦æŠ¥å</button>
      </li>
    </ul>

    <!-- å†…å®¹åŒº -->
    <div class="tab-content mt-3">
      <!-- è¶…åº¦é¢æ¿ -->
      <div class="tab-pane fade show active" id="chaodu-pane" role="tabpanel">
        <div class="p-4 bg-white shadow-sm rounded border">
          <div class="filter-bar">
            <input id="chaoduSearch" class="form-control" placeholder="æ‰‹æœºå·">
            <select id="chaoduType" class="form-select">
              <option value="">å…¨éƒ¨æ³•ä¼š</option>
              <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
              <option value="ä¸­å…ƒèŠ‚">ä¸­å…ƒèŠ‚</option>
              <option value="å…¶ä»–">å…¶ä»–</option>
            </select>
            <button onclick="applyFilter('chaodu')" class="btn btn-sm btn-primary">ç­›é€‰</button>
            <button onclick="resetFilter('chaodu')" class="btn btn-sm btn-secondary">å…¨éƒ¨</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr><th>#</th><th>è¡¨æ ¼å¡«å†™è€…</th><th>æ‰‹æœºå·</th><th>æ˜¯å¦å·²ä»˜æ¬¾</th><th>æ”¶æ¬¾äºº</th></tr>
              </thead>
              <tbody id="chaoduTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- ç¥ˆç¦é¢æ¿ -->
      <div class="tab-pane fade" id="qifu-pane" role="tabpanel">
        <div class="p-4 bg-white shadow-sm rounded border">
          <div class="filter-bar">
            <input id="qifuSearch" class="form-control" placeholder="æ‰‹æœºå·">
            <select id="qifuType" class="form-select">
              <option value="">å…¨éƒ¨æ³•ä¼š</option>
              <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
              <option value="ä¸­å…ƒèŠ‚">ä¸­å…ƒèŠ‚</option>
              <option value="çº¢è´¢ç¥">çº¢è´¢ç¥</option>
            </select>
            <button onclick="applyFilter('qifu')" class="btn btn-sm btn-primary">ç­›é€‰</button>
            <button onclick="resetFilter('qifu')" class="btn btn-sm btn-secondary">å…¨éƒ¨</button>
          </div>
          <div class="table-responsive">
            <table class="table table-bordered table-striped">
              <thead class="table-light">
                <tr><th>#</th><th>è¡¨æ ¼å¡«å†™è€…</th><th>æ‰‹æœºå·</th><th>æ˜¯å¦å·²ä»˜æ¬¾</th><th>æ”¶æ¬¾äºº</th></tr>
              </thead>
              <tbody id="qifuTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ä¸»è¦è„šæœ¬ -->
  <script>
    async function loadSystemData(system, tableId, filter = {}) {
      let endpoint = system === "chaodu" ? "admin-chaodu" : "admin-qifu";

      try {
        const res = await fetch(`https://form.gealarm2012.workers.dev/${endpoint}?list=1`);
        const dataList = await res.json();

        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        tbody.innerHTML = "";
        const phoneFilter = filter.phone || "";
        const typeFilter = system === "chaodu" ? filter.festival || "" : filter.dharmaType || "";

        const filtered = dataList.filter(item => {
          const matchPhone = !phoneFilter || String(item.phoneNumber || '').includes(phoneFilter);
          const matchType = !typeFilter || (
            system === "chaodu"
              ? item.festival === typeFilter
              : item.dharmaType === typeFilter
          );
          return matchPhone && matchType;
        });

        filtered.forEach((item, index) => {
          const paid = String(item.receiptNumber || "").trim();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.mainName || "-"}</td>
            <td>${item.phoneNumber || "-"}</td>
            <td class="${paid ? 'paid' : 'unpaid'}">${paid ? "âœ” å·²ä»˜æ¬¾" : "âŒ æœªä»˜æ¬¾"}</td>
            <td>${paid ? (item.admin || "â€”") : "â€”"}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error(`âŒ åŠ è½½ ${system} ç³»ç»Ÿå¤±è´¥`, err);
        const tbody = document.getElementById(tableId);
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-danger">åŠ è½½å¤±è´¥</td></tr>`;
        }
      }
    }

    function applyFilter(system) {
      const phone = document.getElementById(system + "Search").value.trim();
      let filter = { phone: phone };

      if (system === "qifu") {
        filter.dharmaType = document.getElementById("qifuType").value.trim();
      }
      if (system === "chaodu") {
        filter.festival = document.getElementById("chaoduType").value.trim();
      }

      loadSystemData(system, system + "Table", filter);
    }

    function resetFilter(system) {
      document.getElementById(system + "Search").value = "";
      if (system === "qifu") document.getElementById("qifuType").value = "";
      if (system === "chaodu") document.getElementById("chaoduType").value = "";
      loadSystemData(system, system + "Table");
    }

    // åˆå§‹åŠ è½½
    loadSystemData("qifu", "qifuTable");
    loadSystemData("chaodu", "chaoduTable");
  </script>
</body>
</html>
