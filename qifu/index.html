<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ç¥ˆç¦åå°ç®¡ç†</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>

    body {
    background-color: #fff8e7; /* âœ¨ç±³é»„è‰²ï¼ŒæŸ”å’Œä¸åˆºçœ¼ */}

    .amount-item { min-width: 120px; text-align: left; }
    .amount-formula { min-width: 120px; text-align: left; }
    .amount-value {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      min-width: 100px;
    }
    .amount-currency { margin-right: 5px; }
    .amount-number {
      min-width: 60px;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .amount-total {
      font-weight: bold;
      font-size: 16px;
      margin-top: 8px;
    }
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h2 class="text-center mb-4">ğŸ™ ç¥ˆç¦åå°ç®¡ç†ç³»ç»Ÿ</h2>

    <div class="mb-3 d-flex flex-column align-items-center">
      <div class="d-inline-flex align-items-center gap-2" style="max-width: 600px;">
        <input type="text" id="searchInput" class="form-control" placeholder="è¾“å…¥æ‰‹æœºå·æŸ¥è¯¢..." style="width: 300px;">
        <button onclick="searchPhone()" class="btn btn-primary">æŸ¥è¯¢</button>
        <button onclick="startNewEntry()" class="btn btn-success">æ–°å¢</button>
      </div>
      <div class="text-end mt-2" style="width: 100%;">
        ç®¡ç†å‘˜ï¼š<span id="whoLogin" class="fw-bold text-primary"></span>
        <button onclick="logout()" class="btn btn-sm btn-outline-secondary ms-2">ç™»å‡º</button>
      </div>
    </div>
    

    <div id="resultSelector" class="mb-3"></div>

    <div id="adminForm" class="d-none">
      <div class="card p-3 mb-4">
        <div class="row mb-3">
          <div class="col-md-4">
            <label>æ‰‹æœºå·</label>
            <input id="phoneNumber" class="form-control">
          </div>
          <div class="col-md-4">
            <label>è¡¨æ ¼å¡«å†™è€…</label>
            <input id="mainName" class="form-control">
          </div>
          <div class="col-md-4">
            <label>æ³•ä¼šç±»åˆ«</label>
            <select id="dharmaType" class="form-select">
              <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
              <option value="ä¸­å…ƒèŠ‚">ä¸­å…ƒèŠ‚</option>
              <option value="çº¢è´¢ç¥">çº¢è´¢ç¥</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>æ”¶æ®ç¼–å·</label>
            <input id="receiptNumber" class="form-control">
          </div>
          <div class="col-md-4">
            <label>æ”¶æ¬¾æ—¥æœŸ</label>
            <input id="receiptDate" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label>ç¥ˆç¦æŠ¥åä¾›å…»é‡‘ (éšå–œèµåŠ©)</label>
            <input id="sponsorAmount" type="number" min="0" value="" class="form-control" oninput="updateDonationBreakdown()">
          </div>
        </div>
      </div>

      <h5>ğŸ§â€â™‚ï¸ ç¥ˆç¦è€…èµ„æ–™ï¼ˆæœ€å¤š13ä½ï¼‰</h5>
      <div id="prayersContainer" class="mb-3"></div>
      <button onclick="addPrayer()" class="btn btn-outline-primary mb-3">â• æ–°å¢ç¥ˆç¦è€…</button>

      <div id="donationBreakdown" class="mb-4"></div>

      <div class="d-flex justify-content-center gap-3">
        <button onclick="forceInsertNewEntry()" class="btn btn-success">æ–°å¢ä¿å­˜</button>
        <button onclick="saveChanges()" class="btn btn-primary">æ›´æ–°ä¿å­˜</button>
        <button onclick="deleteEntry()" class="btn btn-warning">åˆ é™¤</button>
        <button onclick="printEntry()" class="btn btn-secondary">æ‰“å°</button>
        <button onclick="printReceipt(getCurrentFormData(), true)">ğŸ‘ï¸ å°ç¥¨é¢„è§ˆ</button>
      </div>
    </div>
  </div>

  <script>
    window.createPrayerBlock = function (data = {}, index = 1) {
      const div = document.createElement("div");
      div.className = "card p-3 mb-3 position-relative";

      const tokenVal = data.token !== undefined ? data.token : '';
      const fireVal = data.fire !== undefined ? data.fire : '';
      const pg3Val = data.pg3 !== undefined ? data.pg3 : '';
      const pg6Val = data.pg6 !== undefined ? data.pg6 : '';

      div.innerHTML = `
        <div style="position:absolute; top:5px; right:10px; cursor:pointer;" onclick="this.parentElement.remove(); updateDonationBreakdown()">âŒ</div>
        <h6 class="mb-3">ğŸ§â€â™€ï¸ ç¬¬ ${index} ä½ç¥ˆç¦è€…</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label>å§“å</label>
            <input type="text" class="form-control name" value="${data.name || ''}">
          </div>
          <div class="col-md-8">
            <label>ç°å±…åœ°å€</label>
            <input type="text" class="form-control address" value="${data.address || ''}">
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-3">
            <label>ç¥ˆç¦ä»¤ç‰Œ</label>
            <input type="number" class="form-control token" value="${tokenVal}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>å°æŠ¤æ‘©ç‰‡</label>
            <input type="number" class="form-control fire" value="${fireVal}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>çº¸é‡‘ 3</label>
            <input type="number" class="form-control pg3" value="${pg3Val}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>çº¸é‡‘ 6</label>
            <input type="number" class="form-control pg6" value="${pg6Val}" oninput="updateDonationBreakdown()">
          </div>
        </div>
      `;

      return div;
    };

    window.updateDonationBreakdown = function () {
      const prayers = document.getElementById("prayersContainer").children;
      let token = 0, fire = 0, pg3 = 0, pg6 = 0;

      Array.from(prayers).forEach(div => {
        token += +div.querySelector(".token")?.value || 0;
        fire  += +div.querySelector(".fire")?.value || 0;
        pg3   += +div.querySelector(".pg3")?.value || 0;
        pg6   += +div.querySelector(".pg6")?.value || 0;
      });

      const sponsor = +document.getElementById("sponsorAmount").value || 0;
      const tokenAmt = token * 5;
      const fireAmt  = fire * 1;
      const pg3Amt   = pg3 * 3;
      const pg6Amt   = pg6 * 6;
      const total    = tokenAmt + fireAmt + pg3Amt + pg6Amt + sponsor;
      window.currentTotalAmount = total;
      function createRow(item, formula, amount) {
  return `
    <div class="total-row">
      <div class="item">${item}</div>
      <div class="formula">${formula}</div>
      <div class="value">
        <span class="currency">RM</span>
        <span class="amount">${amount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
      </div>
    </div>
  `;
}

function createRow(item, formula, value) {
  return `
    <div style="display:flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 4px;">
      <div style="min-width: 150px; text-align:left;">${item}</div>
      <div style="min-width: 140px; text-align:left;">${formula}</div>
      <div style="display: flex; align-items: center; justify-content: flex-end; min-width: 100px;">
        <span style="margin-right: 4px;">RM</span>
        <span style="text-align:right; min-width: 60px;">${value.toFixed(2)}</span>
      </div>
    </div>
  `;
}



document.getElementById("donationBreakdown").innerHTML = `
  ${createRow("ç¥ˆç¦ä»¤ç‰Œ", `RM 5 Ã— ${token} ä¸ª`, tokenAmt)}
  ${createRow("å°æŠ¤æ‘©ç‰‡", `RM 1 Ã— ${fire} ç‰‡`, fireAmt)}
  ${createRow("çº¸é‡‘ 3", `RM 3 Ã— ${pg3} ä»½`, pg3Amt)}
  ${createRow("çº¸é‡‘ 6", `RM 6 Ã— ${pg6} ä»½`, pg6Amt)}
  ${createRow("éšå–œèµåŠ©", "-", sponsor)}
<div style="display:flex; justify-content: flex-end; align-items: center; gap: 10px; font-weight: bold; font-size: 16px; margin-top: 10px;">
  <div style="min-width: 150px; text-align:left;">æ€»è®¡</div>
  <div style="min-width: 140px;"></div>
  <div style="display: flex; align-items: center; justify-content: flex-end; min-width: 100px;">
    <span style="margin-right: 4px;">RM</span>
    <span style="text-align:right; min-width: 60px;">${total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
  </div>
</div>

`;
}

  </script>

  <script src="script/utils.js"></script>
  <script src="script/receipt.js"></script>
  <script src="script/init.js"></script>
  <script src="script/query.js"></script>
  <script src="script/add.js"></script>
  <script src="script/update.js"></script>
  <script src="script/delete.js"></script>
  <script src="script/print.js"></script>

  <script>
    const admin = localStorage.getItem("admin");
    if (!admin) {
      alert("è¯·å…ˆç™»å½•ï¼");
      location.href = "https://leizs2025.github.io/houtai/login.html";
    } else {
      document.getElementById("whoLogin").textContent = admin;
    }

    function logout() {
      localStorage.removeItem("admin");
      location.href = "https://leizs2025.github.io/houtai/login.html";
    }
  </script>

  
</body>
</html>
