<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>祈福后台管理</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>

    body {
    background-color: #fff8e7; /* ✨米黄色，柔和不刺眼 */}
   
  </style>
</head>

<body class="p-4">
  <div class="container">
    <h2 class="text-center mb-4">🙏 祈福后台管理系统</h2>

    <div class="mb-3 d-flex justify-content-between align-items-center">
      <div class="input-group" style="max-width: 500px;">
        <input type="text" id="searchInput" class="form-control" placeholder="输入手机号查询...">
        <button onclick="searchPhone()" class="btn btn-primary">查询</button>
        <button onclick="startNewEntry()" class="btn btn-success">新增</button>
      </div>
      <div class="text-end">
        管理员：<span id="whoLogin" class="fw-bold text-primary"></span>
        <button onclick="logout()" class="btn btn-sm btn-outline-secondary ms-2">登出</button>
      </div>
    </div>

    <div id="resultSelector" class="mb-3"></div>

    <div id="adminForm" class="d-none">
      <div class="card p-3 mb-4">
        <div class="row mb-3">
          <div class="col-md-4">
            <label>手机号</label>
            <input id="phoneNumber" class="form-control">
          </div>
          <div class="col-md-4">
            <label>表格填写者</label>
            <input id="mainName" class="form-control">
          </div>
          <div class="col-md-4">
            <label>法会类别</label>
            <select id="dharmaType" class="form-select">
              <option value="清明节">清明节</option>
              <option value="中元节">中元节</option>
              <option value="红财神">红财神</option>
            </select>
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-4">
            <label>收据编号</label>
            <input id="receiptNumber" class="form-control">
          </div>
          <div class="col-md-4">
            <label>收款日期</label>
            <input id="receiptDate" type="date" class="form-control">
          </div>
          <div class="col-md-4">
            <label>祈福报名供养金 (随喜赞助)</label>
            <input id="sponsorAmount" type="number" min="0" value="" class="form-control" oninput="updateDonationBreakdown()">
          </div>
        </div>
      </div>

      <h5>🧍‍♂️ 祈福者资料（最多13位）</h5>
      <div id="prayersContainer" class="mb-3"></div>
      <button onclick="addPrayer()" class="btn btn-outline-primary mb-3">➕ 新增祈福者</button>

      <div id="donationBreakdown" class="mb-4"></div>

      <div class="d-flex justify-content-center gap-3">
        <button onclick="forceInsertNewEntry()" class="btn btn-success">新增保存</button>
        <button onclick="saveChanges()" class="btn btn-primary">更新保存</button>
        <button onclick="deleteEntry()" class="btn btn-warning">删除</button>
        <button onclick="printEntry()" class="btn btn-secondary">打印</button>
      </div>
    </div>
  </div>

  <script>
    window.createPrayerBlock = function (data = {}, index = 1) {
      const div = document.createElement("div");
      div.className = "card p-3 mb-3 position-relative";

      const tokenVal = data.token !== undefined ? data.token : '';
      const fireVal = data.fire !== undefined ? data.fire : '';
      const pg3Val = data.pg3 !== undefined ? data.pg3 : '';
      const pg6Val = data.pg6 !== undefined ? data.pg6 : '';

      div.innerHTML = `
        <div style="position:absolute; top:5px; right:10px; cursor:pointer;" onclick="this.parentElement.remove(); updateDonationBreakdown()">❌</div>
        <h6 class="mb-3">🧍‍♀️ 第 ${index} 位祈福者</h6>
        <div class="row g-3">
          <div class="col-md-4">
            <label>姓名</label>
            <input type="text" class="form-control name" value="${data.name || ''}">
          </div>
          <div class="col-md-8">
            <label>现居地址</label>
            <input type="text" class="form-control address" value="${data.address || ''}">
          </div>
        </div>
        <div class="row g-3 mt-2">
          <div class="col-md-3">
            <label>祈福令牌</label>
            <input type="number" class="form-control token" value="${tokenVal}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>小护摩片</label>
            <input type="number" class="form-control fire" value="${fireVal}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>纸金 3</label>
            <input type="number" class="form-control pg3" value="${pg3Val}" oninput="updateDonationBreakdown()">
          </div>
          <div class="col-md-3">
            <label>纸金 6</label>
            <input type="number" class="form-control pg6" value="${pg6Val}" oninput="updateDonationBreakdown()">
          </div>
        </div>
      `;

      return div;
    };

    window.updateDonationBreakdown = function () {
      const prayers = document.getElementById("prayersContainer").children;
      let token = 0, fire = 0, pg3 = 0, pg6 = 0;

      Array.from(prayers).forEach(div => {
        token += +div.querySelector(".token")?.value || 0;
        fire  += +div.querySelector(".fire")?.value || 0;
        pg3   += +div.querySelector(".pg3")?.value || 0;
        pg6   += +div.querySelector(".pg6")?.value || 0;
      });

      const sponsor = +document.getElementById("sponsorAmount").value || 0;
      const tokenAmt = token * 5;
      const fireAmt  = fire * 1;
      const pg3Amt   = pg3 * 3;
      const pg6Amt   = pg6 * 6;
      const total    = tokenAmt + fireAmt + pg3Amt + pg6Amt + sponsor;
      window.currentTotalAmount = total;
      const html = `
        <div style="font-size: 14px; line-height: 1.5; text-align: right;">
          ${createRow("祈福令牌", `5 RM × ${token} 个`, tokenAmt)}
          ${createRow("小护摩片", `1 RM × ${fire} 片`, fireAmt)}
          ${createRow("纸金 3", `3 RM × ${pg3} 份`, pg3Amt)}
          ${createRow("纸金 6", `6 RM × ${pg6} 份`, pg6Amt)}
          ${createRow("祈福报名供养金", "", sponsor)}
          <hr>
          <div style="display:flex; justify-content: flex-end; gap: 10px; font-weight: bold; font-size: 15px;">
            <div style="min-width: 180px; text-align:left;">合计总金额</div>
            <div style="min-width: 160px;"></div>
            <div style="min-width: 90px; text-align:right;">RM ${total.toFixed(2)}</div>
          </div>
        </div>
      `;

      document.getElementById("donationBreakdown").innerHTML = html;
    };

function createRow(item, formula, value) {
  return `
    <div style="display:flex; justify-content: flex-end; gap: 12px; line-height: 1.5;">
      <div style="min-width: 160px; text-align:left; padding-left: 20px;">${item}</div>
      <div style="min-width: 130px; text-align:left;">${formula}</div>
      <div style="min-width: 90px; text-align:right;">RM ${value.toFixed(2)}</div>
    </div>
  `;
}


  </script>

  <script src="script/init.js"></script>
  <script src="script/query.js"></script>
  <script src="script/add.js"></script>
  <script src="script/update.js"></script>
  <script src="script/delete.js"></script>
  <script src="script/utils.js"></script>
  <script src="script/print.js"></script>

  <script>
    const admin = localStorage.getItem("admin");
    if (!admin) {
      alert("请先登录！");
      location.href = "https://leizs2025.github.io/houtai/login.html";
    } else {
      document.getElementById("whoLogin").textContent = admin;
    }

    function logout() {
      localStorage.removeItem("admin");
      location.href = "login.html";
    }
  </script>

  <!-- 快速上下按钮 -->
  <button id="scrollTopBtn" onclick="scrollToTop()" style="display:none;position:fixed;bottom:80px;right:20px;z-index:1000;" class="btn btn-outline-secondary btn-sm">🔼 顶部</button>
  <button id="scrollBottomBtn" onclick="scrollToBottom()" style="display:none;position:fixed;bottom:40px;right:20px;z-index:1000;" class="btn btn-outline-secondary btn-sm">🔽 底部</button>

  <script>
    window.addEventListener("scroll", () => {
      const topBtn = document.getElementById("scrollTopBtn");
      const bottomBtn = document.getElementById("scrollBottomBtn");
      const shouldShow = document.documentElement.scrollTop > 200;
      topBtn.style.display = shouldShow ? "block" : "none";
      bottomBtn.style.display = shouldShow ? "block" : "none";
    });

    function scrollToTop() {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function scrollToBottom() {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    }
  </script>
</body>
</html>
