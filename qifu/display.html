<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>å®æ—¶æŠ¥åå±•ç¤º</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <style>
    body {
      padding: 20px;
      background-color: #fff8e7;
    }
    .paid { color: green; font-weight: bold; }
    .unpaid { color: red; }
    h4 { margin-bottom: 10px; }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <h3 class="mb-4 text-center">ğŸ“‹ å®æ—¶æŠ¥ååˆ—è¡¨ï¼ˆå·¦å³å¯¹ç…§ï¼‰</h3>

  <div class="row">
    <!-- è¶…åº¦ç³»ç»Ÿ -->
    <div class="col-md-6">
      <h4>ğŸª· è¶…åº¦æŠ¥å</h4>
      <div class="filter-bar">
        <input id="chaoduSearch" class="form-control" placeholder="æ‰‹æœºå·">
        <button onclick="applyFilter('chaodu')" class="btn btn-sm btn-primary">ç­›é€‰</button>
        <button onclick="resetFilter('chaodu')" class="btn btn-sm btn-secondary">å…¨éƒ¨</button>
      </div>
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr><th>#</th><th>è¡¨æ ¼å¡«å†™è€…</th><th>æ‰‹æœºå·</th><th>æ˜¯å¦å·²ä»˜æ¬¾</th><th>æ”¶æ¬¾äºº</th></tr>
        </thead>
        <tbody id="chaoduTable"></tbody>
      </table>
    </div>

    <!-- ç¥ˆç¦ç³»ç»Ÿ -->
    <div class="col-md-6">
      <h4>ğŸ™ ç¥ˆç¦æŠ¥å</h4>
      <div class="filter-bar">
        <input id="qifuSearch" class="form-control" placeholder="æ‰‹æœºå·">
        <select id="qifuType" class="form-select">
          <option value="">å…¨éƒ¨æ³•ä¼š</option>
          <option value="æ¸…æ˜èŠ‚">æ¸…æ˜èŠ‚</option>
          <option value="ä¸­å…ƒèŠ‚">ä¸­å…ƒèŠ‚</option>
          <option value="çº¢è´¢ç¥">çº¢è´¢ç¥</option>
        </select>
        <button onclick="applyFilter('qifu')" class="btn btn-sm btn-primary">ç­›é€‰</button>
        <button onclick="resetFilter('qifu')" class="btn btn-sm btn-secondary">å…¨éƒ¨</button>
      </div>
      <table class="table table-bordered table-striped">
        <thead class="table-light">
          <tr><th>#</th><th>è¡¨æ ¼å¡«å†™è€…</th><th>æ‰‹æœºå·</th><th>æ˜¯å¦å·²ä»˜æ¬¾</th><th>æ”¶æ¬¾äºº</th></tr>
        </thead>
        <tbody id="qifuTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    async function loadSystemData(system, tableId, filter = {}) {
      let endpoint = system === "chaodu" ? "admin-chaodu" : "admin-qifu";

      try {
        const res = await fetch(`https://form.gealarm2012.workers.dev/${endpoint}?list=1`);
        const dataList = await res.json();

        const tbody = document.getElementById(tableId);
        if (!tbody) return;

        tbody.innerHTML = "";

        const typeFilter = filter.dharmaType || "";
        const phoneFilter = filter.phone || "";

        const filtered = dataList.filter(item => {
          const matchPhone = !phoneFilter || item.phoneNumber?.includes(phoneFilter);
          const matchType = !typeFilter || item.dharmaType === typeFilter;
          return matchPhone && matchType;
        });

        filtered.forEach((item, index) => {
          const paid = String(item.receiptNumber || "").trim();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${index + 1}</td>
            <td>${item.mainName || "-"}</td>
            <td>${item.phoneNumber || "-"}</td>
            <td class="${paid ? 'paid' : 'unpaid'}">${paid ? "âœ” å·²ä»˜æ¬¾" : "âŒ æœªä»˜æ¬¾"}</td>
            <td>${paid ? (item.admin || "â€”") : "â€”"}</td>
          `;
          tbody.appendChild(row);
        });
      } catch (err) {
        console.error(`âŒ åŠ è½½ ${system} ç³»ç»Ÿå¤±è´¥`, err);
        const tbody = document.getElementById(tableId);
        if (tbody) {
          tbody.innerHTML = `<tr><td colspan="5" class="text-danger">åŠ è½½å¤±è´¥</td></tr>`;
        }
      }
    }

    function applyFilter(system) {
      const phone = document.getElementById(system + "Search").value.trim();
      const dharma = system === "qifu" ? document.getElementById("qifuType").value : "";
      loadSystemData(system, system + "Table", { phone: phone, dharmaType: dharma });
    }

    function resetFilter(system) {
      document.getElementById(system + "Search").value = "";
      if (system === "qifu") document.getElementById("qifuType").value = "";
      loadSystemData(system, system + "Table");
    }

    // åˆå§‹åŠ è½½
    loadSystemData("qifu", "qifuTable");
    loadSystemData("chaodu", "chaoduTable");

    // setInterval(() => {
    //   loadSystemData("qifu", "qifuTable");
    //   loadSystemData("chaodu", "chaoduTable");
    // }, 300000); // æ¯5åˆ†é’Ÿåˆ·æ–°
  </script>
</body>
</html>
